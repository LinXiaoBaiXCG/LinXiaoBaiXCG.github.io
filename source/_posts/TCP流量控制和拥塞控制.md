---
title: TCP流量控制和拥塞控制
date: 2021-04-07 20:00:00
tags: [计算机网络]
categories: 编程
---

>  流量控制和拥塞控制是TCP实现可靠传输的方法之一

# 流量控制

## 为什么要流量控制

如果发送端的发送速度太快，会导致接收端的接收缓冲区很快的填充满了。此时如果发送端仍旧发送数据，那么接下来发送的数据都会丢包。 所谓流量控制就是让发送方发送速率不要过快，让接收方来得及接收。

## TCP如何实现流量控制

### 滑动窗口

利用滑动窗口机制可以实现流量控制。

原理就是**运用TCP报文段中的窗口大小字段来控制，发送方的发送窗口不可以大于接收方发回的窗口大小。**

考虑一种特殊的情况，就是接收方若没有缓存足够使用，就会发送零窗口大小的报文，此时发送放将发送窗口设置为0，停止发送数据。之后接收方有足够的缓存，发送了非零窗口大小的报文，但是这个报文在中途丢失的，那么发送方的发送窗口就一直为零导致死锁。

解决这个问题，TCP为每一个连接设置一个持续计时器（persistence timer）。只要TCP的一方收到对方的零窗口通知，**就启动该计时器，周期性的发送一个零窗口探测报文段。对方就在确认这个报文的时候给出现在的窗口大小（注意：**TCP规定，即使设置为零窗口，接收方也必须接收以下几种报文段：零窗口探测报文段、确认报文段和携带紧急数据的报文段）。

# 拥塞控制

## 什么是拥塞控制

TCP传输的过程中，发送端开始发送数据的时候，**如果刚开始就发送大量的数据，那么就可能造成一些问题。网络可能在开始的时候就很拥堵**，如果给网络中在扔出大量数据，那么这个拥堵就会加剧。拥堵的加剧就会产生大量的丢包，就对大量的超时重传，严重影响传输。

##  TCP如何实现拥塞控制

### 拥塞窗口

发送报文段速率的确定，既要根据接收端的接收能力，又要从全局考虑不要使网络发生拥塞，这由接收窗口和拥塞窗口两个状态量确定。

**接收端窗口（Reciver Window)又称通知窗口（Advertised Window)**,是接收端根据目前的接收缓存大小所许诺的最新窗口值，是来自接收端的流量控制。

**拥塞窗口cwnd（Congestion Window)**是**发送端**根据自己估计的网络拥塞程度而设置的窗口动态值，是来自发送端的流量控制。

因特网建议标准RFC2581定义了进行拥塞控制的四种算法，即**慢启动（Slow-start)，拥塞避免（Congestion Avoidance)，快重传（Fast Restrangsmit)和快恢复（Fast Recovery）**

### 慢启动算法和拥塞避免算法

![](TCP流量控制和拥塞控制\微信截图_20210407134157.png)

慢开始算法的思路就是，不要一开始就发送大量的数据，先探测一下网络的拥塞程度，也就是说由小到大逐渐增加拥塞窗口的大小。

当然收到单个确认但此确认多个数据报的时候就加相应的数值。所以一次传输轮次之后拥塞窗口就加倍。这就是乘法增长，和后面的拥塞避免算法的加法增长比较。

为了防止cwnd增长过大引起网络拥塞，还需设置一个慢开始门限ssthresh状态变量。ssthresh的用法如下：

当cwnd<ssthresh时，使用慢开始算法。

当cwnd>ssthresh时，改用拥塞避免算法。

当cwnd=ssthresh时，慢开始与拥塞避免算法任意。

### 快重传算法和快恢复算法

 一条TCP连接有时会因等待重传计时器的超时而空闲较长的时间，慢开始和拥塞避免无法很好的解决这类问题，因此提出了快重传和快恢复的拥塞控制方法。

   **快重传算法**并非取消了**重传机制**，只是在某些情况下更早的重传丢失的报文段（如果当发送端接收到三个重复的确认ACK时，则断定分组丢失，立即重传丢失的报文段，而不必等待重传计时器超时）。

   **快恢复算法**有以下两个要点：

1. 当发送方连续收到接收方发来的三个重复确认时，就执行“乘法减小”算法，把慢开始门限减半，这是为了预防网络发生拥塞。

2. 由于发送方现在认为网络很可能没有发生拥塞，因此现在不执行慢开始算法，而是把**cwnd(拥塞窗口)**值设置为慢开始门限减半后的值，然后开始执行拥塞避免算法**，使拥塞窗口的线性增大**。

![](TCP流量控制和拥塞控制\微信截图_20210407134649.png)

# TCP拥塞控制和流量控制的差别

* 拥塞控制就是防止过多的数据注入到网络中，这样可以使网络中的路由器或链路不致过载。拥塞控制所要做的都有一个前提，就是网络能承受现有的网络负荷。

* 流量控制往往指的是点对点通信量的控制，是个端到端的问题。流量控制所要做的就是控制发送端发送数据的速率，以便使接收端来得及接受。